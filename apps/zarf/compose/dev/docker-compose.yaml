# =============================================================================
# ML Pipeline Development Stack - Docker Compose
# =============================================================================
# Emulates the Kubernetes ml-system namespace for local development.
#
# Services:
#   - minio:            S3-compatible object storage (MinIO)
#   - qdrant:           Vector database (primary)
#   - weaviate:         Vector database (alternative)
#   - weaviate-console: Weaviate Web UI
#   - ollama:           Embedding service (local LLM)
#   - ray-head:         Ray cluster head node
#   - ray-worker:       Ray cluster worker node(s)
#   - pipeline:         FastAPI pipeline service
#
# Usage:
#   docker compose -f zarf/compose/dev/docker-compose.yaml up -d
#   docker compose -f zarf/compose/dev/docker-compose.yaml down
#   docker compose -f zarf/compose/dev/docker-compose.yaml logs -f pipeline
#
# Port Mappings:
#   - 8000: Pipeline API
#   - 9000: MinIO S3 API
#   - 9001: MinIO Console
#   - 6333: Qdrant HTTP API
#   - 6334: Qdrant gRPC API
#   - 8080: Weaviate HTTP API
#   - 8081: Weaviate Console
#   - 11434: Ollama API
#   - 8265: Ray Dashboard
#   - 10001: Ray Client

name: inatinq-ml-stack

services:
  # ---------------------------------------------------------------------------
  # MinIO - S3-compatible Object Storage
  # ---------------------------------------------------------------------------
  minio:
    image: minio/minio:latest
    container_name: minio
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    volumes:
      - minio-data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
    networks:
      - ml-network

  # MinIO initialization - creates the pipeline bucket
  minio-init:
    image: minio/mc:latest
    container_name: minio-init
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      mc alias set local http://minio:9000 minioadmin minioadmin;
      mc mb local/pipeline --ignore-existing;
      mc anonymous set public local/pipeline;
      echo 'MinIO bucket pipeline created successfully';
      exit 0;
      "
    networks:
      - ml-network

  # ---------------------------------------------------------------------------
  # Qdrant - Vector Database (Primary)
  # ---------------------------------------------------------------------------
  qdrant:
    image: qdrant/qdrant:v1.12.4
    container_name: qdrant
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant-data:/qdrant/storage
    environment:
      QDRANT__SERVICE__GRPC_PORT: 6334
    # Qdrant image doesn't have curl/wget, using simple process check
    healthcheck:
      test: ["CMD-SHELL", "timeout 5 bash -c '</dev/tcp/localhost/6333' || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 10s
    networks:
      - ml-network

  # ---------------------------------------------------------------------------
  # Weaviate - Vector Database (Alternative)
  # ---------------------------------------------------------------------------
  weaviate:
    image: semitechnologies/weaviate:1.27.0
    container_name: weaviate
    ports:
      - "8080:8080"
    environment:
      QUERY_DEFAULTS_LIMIT: 25
      AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED: "true"
      PERSISTENCE_DATA_PATH: /var/lib/weaviate
      DEFAULT_VECTORIZER_MODULE: none
      CLUSTER_HOSTNAME: node1
    volumes:
      - weaviate-data:/var/lib/weaviate
    # Weaviate image may not have curl, using wget
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:8080/v1/.well-known/ready || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 10s
    networks:
      - ml-network

  # Weaviate Console - Web UI for Weaviate
  weaviate-console:
    image: semitechnologies/weaviate-console:latest
    container_name: weaviate-console
    ports:
      - "8081:80"
    environment:
      WEAVIATE_API_URL: http://weaviate:8080
    depends_on:
      - weaviate
    networks:
      - ml-network

  # ---------------------------------------------------------------------------
  # Ollama - Embedding Service (Local LLM)
  # ---------------------------------------------------------------------------
  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    ports:
      - "11434:11434"
    volumes:
      - ollama-models:/root/.ollama
    healthcheck:
      test: ["CMD-SHELL", "ollama list || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
      - ml-network

  # Ollama model initialization - pulls the embedding model
  ollama-init:
    image: ollama/ollama:latest
    container_name: ollama-init
    depends_on:
      ollama:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      echo 'Pulling nomic-embed-text model...';
      ollama pull nomic-embed-text;
      echo 'Model pulled successfully';
      exit 0;
      "
    environment:
      OLLAMA_HOST: http://ollama:11434
    networks:
      - ml-network

  # ---------------------------------------------------------------------------
  # Ray Head - Distributed Computing (Head Node)
  # ---------------------------------------------------------------------------
  ray-head:
    image: rayproject/ray:2.53.0-py310
    container_name: ray-head
    ports:
      - "8265:8265"   # Dashboard
      - "20001:20001" # Client port (outside Ray worker port range 10002-19999)
      - "6379:6379"   # Redis/GCS
    command: >
      ray start --head
      --dashboard-host=0.0.0.0
      --port=6379
      --ray-client-server-port=20001
      --block
    shm_size: "2gb"
    environment:
      RAY_DISABLE_DOCKER_CPU_WARNING: "1"
      PYTHONPATH: /app/src
    volumes:
      # Mount pipeline source code so Ray jobs can access it
      - ../../../src:/app/src:ro
    healthcheck:
      test: ["CMD", "ray", "status"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - ml-network

  # ---------------------------------------------------------------------------
  # Ray Worker - Distributed Computing (Worker Node)
  # ---------------------------------------------------------------------------
  ray-worker:
    image: rayproject/ray:2.53.0-py310
    container_name: ray-worker
    command: >
      ray start
      --address=ray-head:6379
      --block
    shm_size: "2gb"
    depends_on:
      ray-head:
        condition: service_healthy
    environment:
      RAY_DISABLE_DOCKER_CPU_WARNING: "1"
      PYTHONPATH: /app/src
    volumes:
      # Mount pipeline source code so Ray jobs can access it
      - ../../../src:/app/src:ro
    deploy:
      replicas: 1
    networks:
      - ml-network

  # ---------------------------------------------------------------------------
  # Pipeline - FastAPI Service
  # ---------------------------------------------------------------------------
  pipeline:
    build:
      context: ../../../
      dockerfile: zarf/docker/dev/Dockerfile.pipeline
    container_name: pipeline
    ports:
      - "8000:8000"
    env_file:
      - ./pipeline.env
    # Cloud/External overrides: set these env vars in shell to use external providers
    environment:
      # Ollama (embedding service)
      - OLLAMA_BASE_URL=${OLLAMA_BASE_URL:-http://ollama:11434}
      - OLLAMA_MODEL=${OLLAMA_MODEL:-nomic-embed-text}
      # Qdrant (vector database)
      - QDRANT_URL=${QDRANT_URL:-http://qdrant:6333}
      - QDRANT_API_KEY=${QDRANT_API_KEY:-}
      # Weaviate (vector database)
      - WEAVIATE_URL=${WEAVIATE_URL:-http://weaviate:8080}
      - WEAVIATE_API_KEY=${WEAVIATE_API_KEY:-}
      - WEAVIATE_GRPC_HOST=${WEAVIATE_GRPC_HOST:-}
    depends_on:
      minio:
        condition: service_healthy
      qdrant:
        condition: service_healthy
      weaviate:
        condition: service_healthy
      ollama:
        condition: service_healthy
      ray-head:
        condition: service_healthy
    volumes:
      - pipeline-data:/data
      # Mount source for development hot-reload (optional)
      # - ../../../src:/app/src:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/healthz"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - ml-network

# =============================================================================
# Volumes
# =============================================================================
volumes:
  minio-data:
    driver: local
  qdrant-data:
    driver: local
  weaviate-data:
    driver: local
  ollama-models:
    driver: local
  pipeline-data:
    driver: local

# =============================================================================
# Networks
# =============================================================================
networks:
  ml-network:
    driver: bridge

