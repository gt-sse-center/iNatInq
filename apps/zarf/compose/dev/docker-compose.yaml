# =============================================================================
# ML Pipeline Development Stack — Optimized for E2E + Ray + Ollama
# Target host resources: ~10 CPUs / ~14.6 GiB RAM (Docker Desktop)
# =============================================================================
# Emulates the Kubernetes ml-system namespace for local development.
#
# Services:
#   - minio:            S3-compatible object storage (MinIO)
#   - qdrant:           Vector database (primary)
#   - weaviate:         Vector database (alternative)
#   - weaviate-console: Weaviate Web UI
#   - ollama:           Embedding service (local LLM)
#   - ray-head:         Ray cluster head node
#   - ray-worker:       Ray cluster worker node(s)
#   - pipeline:         FastAPI pipeline service
#
# Usage:
#   docker compose -f zarf/compose/dev/docker-compose.yaml up -d
#   docker compose -f zarf/compose/dev/docker-compose.yaml down
#   docker compose -f zarf/compose/dev/docker-compose.yaml logs -f pipeline
#
# Port Mappings:
#   - 8000: Pipeline API
#   - 9000: MinIO S3 API
#   - 9001: MinIO Console
#   - 6333: Qdrant HTTP API
#   - 6334: Qdrant gRPC API
#   - 8080: Weaviate HTTP API
#   - 8081: Weaviate Console
#   - 11434: Ollama API
#   - 8265: Ray Dashboard
#   - 10001: Ray Client

name: inatinq-ml-stack

services:
  # ---------------------------------------------------------------------------
  # MinIO — S3-compatible Object Storage
  # ---------------------------------------------------------------------------
  minio:
    image: minio/minio:latest
    container_name: minio
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    volumes:
      - minio-data:/data
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 512m
        reservations:
          cpus: "0.25"
          memory: 256m
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
    networks: [ml-network]

  minio-init:
    image: minio/mc:latest
    container_name: minio-init
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      mc alias set local http://minio:9000 minioadmin minioadmin &&
      mc mb local/pipeline --ignore-existing &&
      mc anonymous set public local/pipeline
      "
    networks: [ml-network]

  # ---------------------------------------------------------------------------
  # Qdrant — Primary Vector DB
  # ---------------------------------------------------------------------------
  qdrant:
    image: qdrant/qdrant:v1.12.4
    container_name: qdrant
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant-data:/qdrant/storage
    environment:
      QDRANT__SERVICE__GRPC_PORT: 6334
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 1g
        reservations:
          cpus: "0.5"
          memory: 512m
    healthcheck:
      test: ["CMD-SHELL", "timeout 5 bash -c '</dev/tcp/localhost/6333' || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 5
    networks: [ml-network]

  # ---------------------------------------------------------------------------
  # Weaviate — Secondary Vector DB
  # ---------------------------------------------------------------------------
  weaviate:
    image: semitechnologies/weaviate:1.27.0
    container_name: weaviate
    ports:
      - "8080:8080"
    environment:
      QUERY_DEFAULTS_LIMIT: 25
      AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED: "true"
      DEFAULT_VECTORIZER_MODULE: none
      PERSISTENCE_DATA_PATH: /var/lib/weaviate
      CLUSTER_HOSTNAME: node1
    volumes:
      - weaviate-data:/var/lib/weaviate
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 1g
        reservations:
          cpus: "0.5"
          memory: 512m
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:8080/v1/.well-known/ready || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 5
    networks: [ml-network]

  # Weaviate Console - Web UI for Weaviate
  weaviate-console:
    image: semitechnologies/weaviate-console:latest
    container_name: weaviate-console
    ports:
      - "8081:80"
    environment:
      WEAVIATE_API_URL: http://weaviate:8080
    depends_on:
      - weaviate
    networks:
      - ml-network

  # ---------------------------------------------------------------------------
  # Ollama — Embedding Model Service
  # ---------------------------------------------------------------------------
  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    ports:
      - "11434:11434"
    volumes:
      - ollama-models:/root/.ollama
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 4g
        reservations:
          cpus: "1.0"
          memory: 2g
    healthcheck:
      test: ["CMD-SHELL", "ollama list || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks: [ml-network]

  ollama-init:
    image: ollama/ollama:latest
    container_name: ollama-init
    depends_on:
      ollama:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "ollama pull nomic-embed-text"
    environment:
      OLLAMA_HOST: http://ollama:11434
    networks: [ml-network]

  # ---------------------------------------------------------------------------
  # Ray Head — Control Plane
  # ---------------------------------------------------------------------------
  ray-head:
    image: rayproject/ray:2.53.0-py311
    container_name: ray-head
    ports:
      - "8265:8265"
      - "20001:20001"
      - "6379:6379"
    command: >
      ray start --head
      --dashboard-host=0.0.0.0
      --num-cpus=0
      --object-store-memory=134217728
      --port=6379
      --ray-client-server-port=20001
      --block
    shm_size: "1gb"
    environment:
      RAY_DISABLE_DOCKER_CPU_WARNING: "1"
      RAY_memory_usage_threshold: "0.98"
      PYTHONPATH: /app/src
    volumes:
      - ../../../src:/app/src:ro
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 5g
        reservations:
          cpus: "1.0"
          memory: 3g
    healthcheck:
      test: ["CMD", "ray", "status"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks: [ml-network]

  # ---------------------------------------------------------------------------
  # Ray Worker — Data Plane
  # ---------------------------------------------------------------------------
  ray-worker:
    image: rayproject/ray:2.53.0-py311
    container_name: ray-worker
    command: >
      ray start
      --address=ray-head:6379
      --num-cpus=4
      --object-store-memory=1073741824
      --block
    shm_size: "2gb"
    depends_on:
      ray-head:
        condition: service_healthy
    environment:
      RAY_DISABLE_DOCKER_CPU_WARNING: "1"
      RAY_memory_usage_threshold: "0.98"
      PYTHONPATH: /app/src
    volumes:
      - ../../../src:/app/src:ro
    deploy:
      resources:
        limits:
          cpus: "4.0"
          memory: 7g
        reservations:
          cpus: "2.0"
          memory: 4g
    networks: [ml-network]

  # ---------------------------------------------------------------------------
  # Pipeline — FastAPI Orchestrator
  # ---------------------------------------------------------------------------
  pipeline:
    build:
      context: ../../../
      dockerfile: zarf/docker/dev/Dockerfile.pipeline
    container_name: pipeline
    ports:
      - "8000:8000"
    env_file:
      - ./pipeline.env
    # Cloud/External overrides: set these env vars in shell to use external providers
    environment:
      # Ollama (embedding service)
      - OLLAMA_BASE_URL=${OLLAMA_BASE_URL:-http://ollama:11434}
      - OLLAMA_MODEL=${OLLAMA_MODEL:-nomic-embed-text}
      # Qdrant (vector database)
      - QDRANT_URL=${QDRANT_URL:-http://qdrant:6333}
      - QDRANT_API_KEY=${QDRANT_API_KEY:-}
      # Weaviate (vector database)
      - WEAVIATE_URL=${WEAVIATE_URL:-http://weaviate:8080}
      - WEAVIATE_API_KEY=${WEAVIATE_API_KEY:-}
      - WEAVIATE_GRPC_HOST=${WEAVIATE_GRPC_HOST:-}
    depends_on:
      minio: { condition: service_healthy }
      qdrant: { condition: service_healthy }
      weaviate: { condition: service_healthy }
      ollama: { condition: service_healthy }
      ray-head: { condition: service_healthy }
    volumes:
      - pipeline-data:/data
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 512m
        reservations:
          cpus: "0.25"
          memory: 256m
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/healthz"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks: [ml-network]

volumes:
  minio-data:
  qdrant-data:
  weaviate-data:
  ollama-models:
  pipeline-data:

networks:
  ml-network:
    driver: bridge