# =============================================================================
# iNatInq Apps Makefile
# =============================================================================
# Convenient targets for development, testing, and Docker operations.

.PHONY: help
help:
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘                         iNatInq Apps Makefile                            â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "â”Œâ”€â”€ Quick Start â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
	@echo "â”‚ make up                Start all services (alias for docker-up)             â”‚"
	@echo "â”‚ make down              Stop all services (alias for docker-down)            â”‚"
	@echo "â”‚ make status            Show service status and health                       â”‚"
	@echo "â”‚ make lazydocker        Launch LazyDocker UI                                 â”‚"
	@echo "â”œâ”€â”€ Development â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
	@echo "â”‚ make test              Run all unit tests                                   â”‚"
	@echo "â”‚ make test-cov          Run tests with coverage report                       â”‚"
	@echo "â”‚ make lint              Run linters (ruff)                                   â”‚"
	@echo "â”‚ make format            Format code (ruff)                                   â”‚"
	@echo "â”‚ make typecheck         Run type checker (mypy)                              â”‚"
	@echo "â”‚ make dev               Start development server (local, no Docker)          â”‚"
	@echo "â”œâ”€â”€ Docker Compose â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
	@echo "â”‚ make docker-up         Start all services                                   â”‚"
	@echo "â”‚ make docker-down       Stop all services                                    â”‚"
	@echo "â”‚ make docker-restart    Restart all services                                 â”‚"
	@echo "â”‚ make docker-logs       Tail logs for all services                           â”‚"
	@echo "â”‚ make docker-ps         Show running containers                              â”‚"
	@echo "â”‚ make docker-build-base Build base image (heavy deps, run once)              â”‚"
	@echo "â”‚ make docker-build      Build pipeline image (fast after base)               â”‚"
	@echo "â”‚ make docker-rebuild    Rebuild and restart pipeline                         â”‚"
	@echo "â”‚ make docker-clean      Stop services and remove volumes                     â”‚"
	@echo "â”‚ make docker-health     Check health of all services                         â”‚"
	@echo "â”œâ”€â”€ Docker Service Logs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
	@echo "â”‚ make logs-pipeline     Tail pipeline logs                                   â”‚"
	@echo "â”‚ make logs-ollama       Tail ollama logs                                     â”‚"
	@echo "â”‚ make logs-qdrant       Tail qdrant logs                                     â”‚"
	@echo "â”‚ make logs-ray          Tail ray-head logs                                   â”‚"
	@echo "â”‚ make logs-minio        Tail minio logs                                      â”‚"
	@echo "â”œâ”€â”€ Docker Shell Access â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
	@echo "â”‚ make shell-pipeline    Shell into pipeline container                        â”‚"
	@echo "â”‚ make shell-ollama      Shell into ollama container                          â”‚"
	@echo "â”œâ”€â”€ Ollama Models â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
	@echo "â”‚ make ollama-pull       Pull nomic-embed-text model                          â”‚"
	@echo "â”‚ make ollama-list       List installed Ollama models                         â”‚"
	@echo "â”œâ”€â”€ Web UIs (opens in browser) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
	@echo "â”‚ make ui-all            Open all web UIs                                     â”‚"
	@echo "â”‚ make ui-pipeline       Open Pipeline API docs (Swagger)                     â”‚"
	@echo "â”‚ make ui-minio          Open MinIO Console                                   â”‚"
	@echo "â”‚ make ui-qdrant         Open Qdrant Dashboard                                â”‚"
	@echo "â”‚ make ui-ray            Open Ray Dashboard                                   â”‚"
	@echo "â”‚ make ui-weaviate       Open Weaviate GraphQL Console                        â”‚"
	@echo "â”œâ”€â”€ Docker Scaling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
	@echo "â”‚ make ray-scale N=3     Scale Ray workers to N replicas                      â”‚"
	@echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"

# =============================================================================
# Variables
# =============================================================================
COMPOSE_FILE := zarf/compose/dev/docker-compose.yaml
DOCKER_COMPOSE := docker compose -f $(COMPOSE_FILE)

# =============================================================================
# Quick Start Aliases
# =============================================================================

.PHONY: up
up: docker-up

.PHONY: down
down: docker-down

.PHONY: status
status: docker-health

.PHONY: lazydocker
lazydocker:
	@command -v lazydocker >/dev/null 2>&1 || { echo "âŒ lazydocker not installed. Run: brew install lazydocker"; exit 1; }
	@lazydocker

# =============================================================================
# Development
# =============================================================================

.PHONY: test
test:
	@echo "Running unit tests..."
	uv run pytest tests/unit/ -v

.PHONY: test-cov
test-cov:
	@echo "Running tests with coverage..."
	uv run pytest tests/unit/ -v --cov=src --cov-report=html --cov-report=term

.PHONY: lint
lint:
	@echo "Running linters..."
	uv run ruff check src/ tests/

.PHONY: format
format:
	@echo "Formatting code..."
	uv run ruff format src/ tests/
	uv run ruff check --fix src/ tests/

.PHONY: typecheck
typecheck:
	@echo "Running type checker..."
	uv run mypy src/

.PHONY: dev
dev:
	@echo "Starting development server..."
	uv run uvicorn api.app:app --reload --host 0.0.0.0 --port 8000

# =============================================================================
# Docker Compose Operations
# =============================================================================

.PHONY: docker-up
docker-up:
	@echo "Starting all services..."
	$(DOCKER_COMPOSE) up -d
	@echo ""
	@echo "âœ… Services started!"
	@echo ""
	@echo "ğŸ“ Service endpoints:"
	@echo "   Pipeline API:    http://localhost:8000"
	@echo "   Pipeline Docs:   http://localhost:8000/docs"
	@echo "   MinIO Console:   http://localhost:9001"
	@echo "   Qdrant Dashboard: http://localhost:6333/dashboard"
	@echo "   Ray Dashboard:   http://localhost:8265"
	@echo "   Ollama:          http://localhost:11434"

.PHONY: docker-down
docker-down:
	@echo "Stopping all services..."
	$(DOCKER_COMPOSE) down

.PHONY: docker-logs
docker-logs:
	$(DOCKER_COMPOSE) logs -f

.PHONY: docker-ps
docker-ps:
	$(DOCKER_COMPOSE) ps

.PHONY: docker-build-base
docker-build-base:
	@echo "Building pipeline base image (heavy dependencies)..."
	@echo "This may take 5-10 minutes on first build..."
	docker build -f zarf/docker/base/Dockerfile.pipeline-base -t inatinq/pipeline-base:0.1.0 .
	@echo "âœ… Base image built: inatinq/pipeline-base:0.1.0"

.PHONY: docker-build
docker-build:
	@echo "Building pipeline image..."
	@docker image inspect inatinq/pipeline-base:0.1.0 >/dev/null 2>&1 || { \
		echo "âš ï¸  Base image not found. Building it first..."; \
		$(MAKE) docker-build-base; \
	}
	$(DOCKER_COMPOSE) build pipeline

.PHONY: docker-rebuild
docker-rebuild:
	@echo "Rebuilding and restarting pipeline..."
	@docker image inspect inatinq/pipeline-base:0.1.0 >/dev/null 2>&1 || { \
		echo "âš ï¸  Base image not found. Building it first..."; \
		$(MAKE) docker-build-base; \
	}
	$(DOCKER_COMPOSE) up -d --build pipeline

.PHONY: docker-clean
docker-clean:
	@echo "âš ï¸  Stopping services and removing volumes..."
	$(DOCKER_COMPOSE) down -v
	@echo "âœ… Cleanup complete"

.PHONY: docker-restart
docker-restart:
	@echo "Restarting all services..."
	$(DOCKER_COMPOSE) restart
	@echo "âœ… Services restarted"

.PHONY: docker-health
docker-health:
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘                         Service Health Status                            â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@$(DOCKER_COMPOSE) ps --format "table {{.Name}}\t{{.Status}}\t{{.Ports}}"
	@echo ""
	@echo "â”Œâ”€â”€ Endpoint Health Checks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
	@printf "â”‚ Pipeline API:    "; curl -sf http://localhost:8000/healthz >/dev/null && echo "âœ… healthy" || echo "âŒ unhealthy"
	@printf "â”‚ Qdrant:          "; curl -sf http://localhost:6333/readyz >/dev/null && echo "âœ… healthy" || echo "âŒ unhealthy"
	@printf "â”‚ Weaviate:        "; curl -sf http://localhost:8080/v1/.well-known/ready >/dev/null && echo "âœ… healthy" || echo "âŒ unhealthy"
	@printf "â”‚ Ollama:          "; curl -sf http://localhost:11434/api/tags >/dev/null && echo "âœ… healthy" || echo "âŒ unhealthy"
	@printf "â”‚ MinIO:           "; curl -sf http://localhost:9000/minio/health/live >/dev/null && echo "âœ… healthy" || echo "âŒ unhealthy"
	@printf "â”‚ Ray Dashboard:   "; curl -sf http://localhost:8265 >/dev/null && echo "âœ… healthy" || echo "âŒ unhealthy"
	@echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
	@echo ""
	@echo "ğŸ“ Service Endpoints:"
	@echo "   Pipeline API:     http://localhost:8000"
	@echo "   Pipeline Docs:    http://localhost:8000/docs"
	@echo "   MinIO Console:    http://localhost:9001 (minioadmin/minioadmin)"
	@echo "   Qdrant Dashboard: http://localhost:6333/dashboard"
	@echo "   Ray Dashboard:    http://localhost:8265"
	@echo "   Weaviate:         http://localhost:8080"
	@echo "   Ollama:           http://localhost:11434"

# =============================================================================
# Docker Service Logs
# =============================================================================

.PHONY: logs-pipeline
logs-pipeline:
	$(DOCKER_COMPOSE) logs -f pipeline

.PHONY: logs-ollama
logs-ollama:
	$(DOCKER_COMPOSE) logs -f ollama

.PHONY: logs-qdrant
logs-qdrant:
	$(DOCKER_COMPOSE) logs -f qdrant

.PHONY: logs-ray
logs-ray:
	$(DOCKER_COMPOSE) logs -f ray-head

.PHONY: logs-minio
logs-minio:
	$(DOCKER_COMPOSE) logs -f minio

# =============================================================================
# Docker Scaling
# =============================================================================

N ?= 1
.PHONY: ray-scale
ray-scale:
	@echo "Scaling Ray workers to $(N) replicas..."
	$(DOCKER_COMPOSE) up -d --scale ray-worker=$(N)

# =============================================================================
# Docker Shell Access
# =============================================================================

.PHONY: shell-pipeline
shell-pipeline:
	@echo "Opening shell in pipeline container..."
	$(DOCKER_COMPOSE) exec pipeline /bin/bash

.PHONY: shell-ollama
shell-ollama:
	@echo "Opening shell in ollama container..."
	$(DOCKER_COMPOSE) exec ollama /bin/bash

# =============================================================================
# Ollama Model Management
# =============================================================================

.PHONY: ollama-pull
ollama-pull:
	@echo "Pulling nomic-embed-text model..."
	$(DOCKER_COMPOSE) exec ollama ollama pull nomic-embed-text
	@echo "âœ… Model pulled successfully"

.PHONY: ollama-list
ollama-list:
	@echo "Installed Ollama models:"
	$(DOCKER_COMPOSE) exec ollama ollama list

MODEL ?= nomic-embed-text
.PHONY: ollama-pull-model
ollama-pull-model:
	@echo "Pulling model: $(MODEL)..."
	$(DOCKER_COMPOSE) exec ollama ollama pull $(MODEL)
	@echo "âœ… Model $(MODEL) pulled successfully"

# =============================================================================
# Web UIs (opens in browser)
# =============================================================================

# Detect OS for open command
UNAME_S := $(shell uname -s)
ifeq ($(UNAME_S),Darwin)
    OPEN_CMD := open
else ifeq ($(UNAME_S),Linux)
    OPEN_CMD := xdg-open
else
    OPEN_CMD := start
endif

.PHONY: ui-all
ui-all: ui-pipeline ui-minio ui-qdrant ui-ray
	@echo "âœ… All UIs opened in browser"

.PHONY: ui-pipeline
ui-pipeline:
	@echo "Opening Pipeline API docs (Swagger)..."
	@$(OPEN_CMD) http://localhost:8000/docs

.PHONY: ui-minio
ui-minio:
	@echo "Opening MinIO Console..."
	@echo "   Login: minioadmin / minioadmin"
	@$(OPEN_CMD) http://localhost:9001

.PHONY: ui-qdrant
ui-qdrant:
	@echo "Opening Qdrant Dashboard..."
	@$(OPEN_CMD) http://localhost:6333/dashboard

.PHONY: ui-ray
ui-ray:
	@echo "Opening Ray Dashboard..."
	@$(OPEN_CMD) http://localhost:8265

.PHONY: ui-weaviate
ui-weaviate:
	@echo "Opening Weaviate GraphQL Console..."
	@$(OPEN_CMD) http://localhost:8080/v1/graphql

